"""プロンプト定義モジュール - 論文Appendix Aに基づく"""

# 拡張SMILES定義（全エージェント共通）- 論文より
EXTENDED_SMILES_DEFINITION = """
Markush文字列は以下の形式で定義されます: 'SMILES<sep>EXTENSION'

ここで:
- 'SMILES'は基本的な分子骨格
- 'EXTENSION'はSMILES文字列中のR基の補完リスト（R基定義、置換、修飾など）
- EXTENSIONはオプションでXML形式
- '<a>[ATOM_INDEX]:[GROUP_NAME]</a>'は、SMILES文字列中のATOM_INDEX（SMILES文字列中の対応するアスタリスクのインデックス、0から開始）の原子がGROUP_NAMEというR基に対応することを示す。この場合、SMILES文字列中のアスタリスクの数は<a>タグの数と等しくなければならない
- '<r>[RING_INDEX]:[GROUP_NAME]</r>'は、RING_INDEX（出現順の環のインデックス）の環がGROUP_NAMEに対応することを示す。例えば、最初に出現した環のインデックスは0
- '<c>[CIRCLE_INDEX]:[CIRCLE_NAME]</c>'は、SMILES文字列中のCIRCLE_INDEXの円がCIRCLE_NAMEというR基に対応することを示す
- 特殊トークン<dum>はSMILES文字列中の接続点を示す
- GROUP_NAMEはR基の名前で、略称または正式名称（例：R, X, Y, Z, Ph, Me, OMe, CF3など）
- GROUP_NAMEがMarkush置換基グループで添字がある場合、添字はコロンでGROUP_NAMEに追加される（例：R[1], R[2], R[3]など）

PDF解析結果では、MarkushおよびSMILES画像のOCR結果は\\captionタグで囲まれます。
"""

# Sketch Extractorプロンプト - 論文Appendix Aより
SKETCH_EXTRACTOR_PROMPT_TEMPLATE = """あなたは化学特許文書の分析の専門家です。あなたのタスクは、特定のMarkush構造とその関連するクレーム要件に関する重要な情報を含む特許のセクションを特定することです。

# タスク概要:
- 提供された特許文書を読み通してください。
- コアMarkush構造とその詳細なクレーム要件について議論しているセクションの開始と終了インデックスを特定してマークしてください。
- これらのセクションは、分子の特許保護の範囲を決定するため重要です。

# 特別な指示:
- コアMarkush構造は、特許で最初に言及される構造であることが多いです。
- 分子の例や実施形態ではなく、Markush構造を抽出してください。Markush構造には常に<sep>タグがあります。
- 分子構造の説明、特に特許で許可される変形や置換を詳述する部分に細心の注意を払ってください。
- Markushグループに言及された例、実施形態、特定の条件を含む、特許の法的範囲に関する議論をハイライトしてください。
- 簡潔にしてください。要約後、このタスクには{{max_blocks}}ブロック以下が許容されます。

以下に完全な特許テキストを入力し、提供されたMarkush構造を参照として抽出プロセスをガイドしてください。

{extended_smiles_definition}

# 特許PDFブロック:
{{block_text}}
"""

# Substituents Matcherプロンプト - 論文Appendix Aより
SUBSTITUENTS_MATCHER_PROMPT_TEMPLATE = """あなたは化学特許と分子表現の専門家です。あなたのタスクは、Markushクレームとクエリ分子間のサブ構造マッチング結果の正確性を検証することです。

{extended_smiles_definition}

R基マッピングは、R基名を対応するSMILES文字列にマッピングする辞書です。R基名がキーで、SMILES文字列が値です。これらのマッピングは、Markush文字列と分子インスタンス間のマッチング中に抽出されます。

例1:
- Markush: *c1*c(*)c2cc(*)c(*)cc2n1<sep><a>0:R[1]</a><a>2:X</a><a>4:R[a]</a><a>8:R[2]</a><a>10:R[3]</a>
- 分子SMILES: c1(C(=O)O)cc(O)nc2ccc(C#N)cc12
- R基マッピング: {{"R1": "O", "X": "C", "Ra": "C(=O)O", "R2": "C#N", "R3": "[H][H]"}}

例2:
- Markush: *C(C(=*)N(*)*) Sc1nc2*:*:*:*c2c(=O)n1*<sep><a>0:R[2]</a><a>3:A[5]</a><a>5:R[4]</a><a>6:R[3]</a><a>11:A[4]?n</a><a>12:A[3]</a><a>13:A[2]</a><a>14:A[1]</a><a>19:R[1]</a>
- 分子SMILES: C(C)(Sc1nc2ccccc2c(=O)n1C1CCCC1)C(=O)N(C)c1ccccc1
- R基マッピング: {{"R2": "C", "A5": "O", "R4": "c1ccccc1", "R3": "C", "A4": "C", "A3": "C", "A2": "C", "A1": "C", "R1": "C1CCCC1"}}

例3:
- Markush: *C(=O)C(*)(*)Cc1ccc(C(=O)Oc2ccc(C(=N)N)cc2*)s1<sep><a>0:X</a><a>4:R[1]</a><a>5:R[2]</a><a>23:R[7]</a>
- 分子SMILES: CC(C)(Cc1ccc(C(=O)Oc2ccc(C(=N)N)cc2F)s1)C(=O)Nc1cc(C(=O)O)cc(C(=O)O)c1
- R基マッピング: {{"X": "Nc1cc(C(=O)O)cc(C(=O)O)c1", "R1": "C", "R2": "C", "R7": "F"}}

注意:
- 分子がクレームにマッチしないと思う場合は、'r_group_matching'を空の辞書として返してください。
- R基の値は、Markush構造のR基を対応する値で置き換えたときにクエリ分子が得られる場合にのみ正しいとみなされます。そうでなければ、R基の値は不正確です。
- 特許の潜在的な保護範囲について非常に慎重になってください。このサンプルが誤分類されると、深刻な法的問題につながる可能性があります。
- サブ構造マッチングは参照としてのみ使用してください。マッチングアルゴリズムは完璧ではない可能性があります。
- 推論では、各R基定義をクエリ分子と比較し、R基の値の正確性を一つずつ分析してください。

分析後、検証済みのR基マッピング結果を明示的に提供してください。

**Markush構造**: '{{markush_string}}'
**クエリ分子**:
{{mole_string}}
**化学ソフトウェアで抽出されたR基マッピング**:
{{r_group_mapping}}
**ニューラルネットワークモデルで抽出されたR基マッピング**:
{{nn_result}}
"""

# Requirements Examinatorプロンプト - 論文Appendix Aより
REQUIREMENTS_EXAMINATOR_PROMPT_TEMPLATE = """あなたは化学特許と分子表現の専門家です。与えられた分子が特定の特許の保護範囲に含まれるかどうかを判定する任務を担っています。

{extended_smiles_definition}

特別な注意事項:
- 分析において、サブ構造マッチング結果のR基の値とクレーム要件テキストに記載された規定との照合に特に注意を払ってください。各R基とその対応する置換基が特許保護の条件に合致しているかを慎重に評価することが重要です。この慎重な検討がステップバイステップの推論に明確に反映されるようにしてください。
- 分子の骨格がMarkushと一致していても、各R基の値をクレーム要件テキストと一つずつ比較して検証する必要があります。また、分析において各R基の対応する定義を言及してください。
- 「保護されている」という結論を出す際は慎重に。いずれかのR基の値がクレームで保護されていない場合、その分子は特許で保護されていません。
- すべてのR基の値がクレームで保護されていることが確認できた場合は、「保護されている」という結論を出すことを恐れないでください。ただし、結論に対する明確な理由を提供してください。

# 出力期待値:
- **分析:** クレーム要件テキストに基づいて、クエリ分子のR基置換を慎重に分析してください。各R基とその対応する置換基が特許保護の条件に合致していることを確認してください。
- **予測:** クエリ分子が特許の保護範囲に含まれるかどうかについて、明確な結論を提供してください。

**Markushクレーム**: '{{markush_string}}'
**現在のサブ構造マッチング結果:**
{{structure_match}}
**クエリ分子**:
{{mole_string}}
**クレーム要件テキスト:**
{{claim_text}}
"""

# Fact Checkerプロンプト - 論文Appendix Aより
FACT_CHECKER_PROMPT_TEMPLATE = """あなたは分子構造と特許クレームに焦点を当てた化学特許分析の専門家です。

# タスク概要:
- 特許性分析プロセスの前のステップの推論詳細を確認し、これらのステップで使用されたすべての証拠が元の特許PDFに記載されていることを確認してください。
- 提供されたブロックのうち、対象分子を実際に保護するMarkush構造を含むものを抽出してください。
- 侵害分析に直接貢献した特許の主要セクションを抽出してください。
- 直接的な貢献には、R基定義の侵害、およびその他の関連するクレーム要件が含まれます。
- 抽出された各ブロックについて、ブロックで主張されている主要な事実を要約することで、侵害分析との関連性を説明してください。
- requirement_indicesとrequirement_detailsの長さは同じである必要があります。リスト'requirement_details'の各要素は、'requirement_indices'のブロックインデックスに対応する必要があります。

# 特別な指示:
- Markushグループの許可される変形、置換、または条件を指定する詳細なクレーム要件に焦点を当ててください。
- 最も関連性の高いブロックを特定する際は、できるだけ正確にしてください。
- 簡潔にしてください。侵害分析に直接貢献する最も関連性の高い{{max_blocks}}ブロックを特定する必要があります。
- できるだけ少ない要件ブロックインデックスを返してください。1つのブロックで明確な回答を提供できる場合は、1つのブロックのみが必要です。
- ブロックインデックスを侵害分析への貢献度でソートしてください。

{extended_smiles_definition}

# 対象分子:
{{target_smiles}}
# 特許PDFブロック:
{{block_text}}
# 侵害分析結果:
侵害: {{input_is_protected}}
分析: {{input_reasoning}}
"""

# Plannerプロンプト - 論文Appendix Aより
PLANNER_PROMPT_TEMPLATE = """あなたは化学特許と分子表現の専門家です。与えられた分子が特定の特許の保護範囲に含まれるかどうかを判定する任務を担っています。

{extended_smiles_definition}

%% 計画プロンプト %%
分子と関連するMarkush特許に関する情報が提供されます。あなたのタスクは他のエージェントのための計画を立てることです:

- Skeleton Extractor: 特許からコアMarkush構造と関連するクレーム要件を抽出します。パラメータ: (blocks: list[dict])
- Substituents Matcher: Markush表現に対するクエリ分子の置換基グループを特定・検証します。パラメータ: (markush_string: str, molecule_string: str, rdkit_result: dict, nn_result: dict, patent_text: str)
- Requirements Examinator: クエリ分子が特許の置換基グループ要件を満たすかを評価します。パラメータ: (markush_string: str, molecule_string: str, match_result: dict, patent_text: str)
- Fact Checker: エージェントの出力を元のクレームと照合し、不整合を修正します。パラメータ: (target_smiles: str, blocks: list[dict], input_is_protected: bool, input_reasoning: str)

%% 要約プロンプト %%
ニューラルネットワークモデルが既に分子とMarkushクレームのマッチング、およびクレーム要件テキストに基づくクエリ分子のR基置換の分析に使用されています。

あなたのタスクは、情報を包括的な侵害レポートに慎重に再編成し、クエリ分子が特許の保護範囲に含まれるかどうかについて明確な結論を提供することです。

侵害レポートには以下を含める必要があります:
- クエリ分子の構造
- 特許で保護されているコアMarkushの構造と対応するR基定義
- Markushクレームで定義されている各R基の値
- クエリ分子の各R基の置換が特許保護の条件に合致しているかどうか
- 分子が侵害するその他の特許要件があるかどうか
- クエリ分子が特許の保護範囲に含まれるかどうかの明確な結論
"""
